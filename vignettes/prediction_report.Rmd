---
title: "Forecasting time-varying transmission during the COVID-19 outbreak"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{prediction_report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

*N. Bosse (1), S. Abbott (1), J. D. Munday (1), J. Hellewell (1), CMMID COVID team (1), S. Funk (1).*

*Correspondence to: nikos.bosse@lshtm.ac.uk* 

*1. Center for the Mathematical Modelling of Infectious Diseases, London School of Hygiene & Tropical Medicine, London WC1E 7HT, United Kingdom*

*Last Updated:* `r (Sys.Date() - 1)`

*Note: this is preliminary analysis, has not yet been peer-reviewed and is updated daily as new data becomes available. This work is licensed under a [Creative Commons Attribution 4.0 International License](https://creativecommons.org/licenses/by/4.0/). A summary of this report can be downloaded [here](https://cmmid.github.io/topics/covid19/current-patterns-transmission/reports/global-time-varying-transmission/summary.pdf)*




```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  echo = FALSE, eval = TRUE,
  #fig.width = 6, fig.height = 3,
  message = FALSE,
  warning = FALSE,
  error = TRUE,
  dpi = 320,
  fig.path = "figure/"
)
```

```{r load-packages, include=FALSE}
# library(epipredictr)
# library(rstan)
# options(mc.cores = 4)
# rstan_options(auto_write = TRUE)
library(ggplot2)
library(scoringutils)
library(dplyr)
library(cowplot)
library(patchwork)
library(bsts)
par(family = "Serif")
source("../R/utilities.R")
source("../R/forecast.R")
```


```{r load-data, include=FALSE}

# sk <- readRDS("../data/time_varying_params_south_korea.rds")[[1]]
# it <- readRDS("../data/time_varying_params_italy.rds")[[1]]
# # uk <- readRDS("data/time_varying_params_uk.rds")[[1]]
# jp <- readRDS("../data/time_varying_params_japan.rds")[[1]]
# sp <- readRDS("../data/time_varying_params_singapore.rds")[[1]]
# 
# y_sk <- sk$median
# y_jp <- jp$median
# y_sp <- sp$median
# y_it <- it$median
# 
# y_sk <- sk$median[1:10]
# y_jp <- jp$median[1:10]
# y_sp <- sp$median[1:10]
# y_it <- it$median[1:10]

inputdata <- load_all_timeseries(base_dir = "../data/Rt_estimates", 
                                 date = as.Date("2020-03-09"))
inputdata <- inputdata[1:17, ]


```

```{r do-analysis, include=FALSE}

models <- c("local", "semilocal", "local_student", "ar1", "ar2")

data <- list(inputdata = inputdata, 
             models = models,
             n_pred = 7,
             start_period = 4)

 
# data <- list(timeseries = timeseries, 
# 			 countries = countries, 
# 			 models = models, 
# 			 n_pred = 7,
# 			 start_period = 8)

analysis <- full_analysis(data)

prediction_results <- lapply(
  seq_along(analysis$countries),
  FUN = function(i) {
    region <- analysis$countries[i]
    region_res <-
      analysis$country_results[[region]]$forecast_res$average
    forecast_table(region_res, region)
  }
)

summary_prediction_result <- do.call(rbind, prediction_results)



```


# Summary {.tabset}

### Aim
Forecast the time-varying $R_t$ estimates into the future to get a sense of the trajectory of the COVID-19 epidemic in different countries. 

## Key Results {.tabset}


### graph
```{r Summary-results-graph}
patchwork::wrap_plots(analysis$predictions_best, ncol = 2)

```

### table
```{r Summary-results}
knitr::kable(summary_prediction_result[,-1])
```


## Abstract

## Methods
We used three different models

1. windowed regression
2. BSTS with a global trend
3. BSTS with a local trend
4. BSTS with an AR 1

to forecast transmission rates. Predictions were made using R and Stan and the 
bsts package and results were scored using CRPS and LogS using the scoringRules 
package. 


# Details {.tabset}

## Methods {.tabset}

### Limitations

## Scoring {.tabset}

### Boxplot
```{r Scoring-boxplot}
analysis$scoring$boxplot
```

### Lineplot
```{r Scoring-lineplot}
analysis$scoring$lineplot
```

### total scores
```{r Scoring-total-scores}
knitr::kable(analysis$scoring$across_country_scores)
```

### mean score across countries
```{r Scoring-ranked-mean}
knitr::kable(analysis$scoring$scores_ranked_mean)
```

## Results by country {.tabset}

### South Korea {.tabset}

#### Prediction vs. Actual

```{r South-Korea, fig.width=10, fig.height=11}
analysis$country_results$South_Korea$forecast_plot

```

### Prediction Scores


### Japan {.tabset}

#### Prediction vs. Actual

```{r Japan, fig.width=10, fig.height=11}
analysis$country_results$Japan$forecast_plot

```

### Prediction Scores


### Singapore {.tabset}

#### Prediction vs. Actual

```{r Singapore, fig.width=10, fig.height=11}
analysis$country_results$Singapore$forecast_plot

```

### Prediction Scores



### Italy {.tabset}

#### Prediction vs. Actual

```{r Italy, fig.width=10, fig.height=11}
analysis$country_results$Italy$forecast_plot

```

### Prediction Scores
